<!DOCTYPE html>
  <html>
  <head>
    <title>Broker AI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="TODO" />
    <meta name="keywords" content="TODO" />
    <meta name="author" content="TODO" />
    <link href="css/jquery-ui.min.css" rel="stylesheet" />
    <link href="css/pdf_viewer.css" rel="stylesheet" />
    <style>
      html, body { min-height: 100% !important; height: 100%; padding: 0; margin: 0; }
       div#top { width: 100%; height: 100%; display: flex; }
        div#left { width: 40%; height: 100%; }
         div#pdf-viewer { overflow: auto; position: absolute; width: 40%; height: 100%; }
        div#right { width: 60%; height: 100%; }
         div#search-box { height: 5%; display: flex; }
          textarea#ta-search { width: 60%; }
         div#docs-container { height: 94.5%; }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/pdf.min.mjs" type="module"></script>
    <script src="js/pdf_viewer.mjs" type="module"></script>
    <script src="js/simpleviewer.mjs" type="module"></script>
    <script type="text/javascript">
      $(function() {

          $.ajaxSetup({
              contentType: "application/json; charset=utf-8",
              method:      "POST",
              dataType:    "json"
          });

          docs = [];
          $('div#docs').accordion({
              collapsible: true,
              heightStyle: "fill",
              activate: function(event, ui) {
                  if(ui.newHeader.length)
                      globalThis.loadPDFtoViewer("pdfs/" + docs[Number(ui.newHeader.data('docIdx'))].file_name);//.then();
              }
          }) ;
          $.ajax({
              url:     "/documents",
              data:    {},
              success: function(data) {
                  docs = data.documents;
                  $.each(docs, function(docIdx, doc) {
                      $('div#docs').append("<h3 data-doc-idx=" + docIdx + ">" + doc.title + "</h3>");
                      $('div#docs').append("<div id='doc-" + docIdx + "'></div>");
                  });
                  $('div#docs').accordion("refresh");
                  globalThis.loadPDFtoViewer("pdfs/" + docs[docs.length-1].file_name);//.then();
              },
              error:   function() {
                  // TODO
              }
          });

          $(window).on('resize', function() {
              globalThis.pdfViewer.currentScaleValue = "page-width";
              $('div#docs').accordion("refresh");
          });

// globalThis.pdfViewer.currentPageNumber = 10;
          $('button#btn-submit').button({'disabled': true});
          $('textarea#ta-search').on('keyup', function() {
              $('button#btn-submit').button('option', 'disabled', $(this).val() == "");
          });

          $('button#btn-submit').on('click', function() {
              $.each(docs, function(docIdx, doc) {
                  $.ajax ({
                      url:     "/search",
                      data:    JSON.stringify({id: doc.id, query: $('textarea#ta-search').val()}),
                      success: function(data) {
                          $('div#doc-' + docIdx).append("<div>" + data.result + "</div>");
                          $('div#docs').accordion("refresh");
                      },
                      error:   function() {
                          // TODO
                      }
                  });
              });
          });
      });
    </script>
  </head>
  <body>
    <div id="top">

      <div id="left">
        <div id="pdf-viewer">
          <div id="viewer" class="pdfViewer"></div>
        </div>
      </div>

      <div id="right">
        <div id="search-box">
          <textarea id="ta-search" class="ui-widget" placeholder="Search query"></textarea>
          <button id="btn-submit">Submit</button>
        </div>

        <div id="docs-container">
          <div id="docs">
          </div>
        </div>

      </div>

    </div>
   </body>
</html>